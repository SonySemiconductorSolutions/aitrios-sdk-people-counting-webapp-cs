@*
 * Copyright (c) 2023 Sony Semiconductor Solutions Corporation
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
*@

@{
    ViewData["Title"] = "Dashboard";
}

<body id="page-top">
    <div id="wrapper">
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">
                <div class="container-fluid">
                    <div class="d-sm-flex align-items-center justify-content-between mb-2">
                        <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
                    </div>
                    <div class="row">
                        <div class="col-xl-9">
                            <div class="card shadow mb-4">
                                <div
                                    class="card-header py-3 d-flex flex-row
                                    align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold
                                        text-primary">People Counting</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-config d-flex">
                                        <select id="chartDeviceList"
                                            class="form-control select"
                                            style="width: 50%;">
                                        </select>
                                    </div>
                                    <div class="chart-area">
                                        <canvas id="mainChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3">
                            <div class="row">

                                <div class="col-xl-12">
                                    <div class="card shadow mb-4">
                                        <div
                                            class="card-header py-3 d-flex flex-row
                                            align-items-center justify-content-between">
                                            <h6 class="m-0 font-weight-bold
                                                text-primary">Current users</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="text-center h-50">
                                                <div class="display-2 font-weight-bold
                                                    text-secondary text-uppercase mb-4"
                                                    id="countDisplay">
                                                    0
                                                </div>
                                            </div>
                                            <div class="text-sm text-center
                                                font-weight-bold text-secondary
                                                text-uppercase mb-1" id="timeDisplay">
                                                YYYY/MM/DD hh:mm:ss
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-12">
                                    <div class="card shadow mb-4">
                                        <div
                                            class="card-header py-3 d-flex flex-row
                                            align-items-center justify-content-between">
                                            <h6 class="m-0 font-weight-bold
                                                text-primary">Notification</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="text-center h-50">
                                                <textarea class="form-control" id="notificationTextarea" type="text" aria-label="Disabled input example" rows="3"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Cards -->
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-primary shadow h-100
                                py-2">
                                <div class="card-body">
                                    <div class="row no-gutters
                                        align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold
                                                text-secondary text-uppercase
                                                mb-1">
                                                Today's max users(sample)</div>
                                            <div class="h5 mb-0 font-weight-bold
                                                text-gray-800">6</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-users fa-2x
                                                text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-success shadow h-100
                                py-2">
                                <div class="card-body">
                                    <div class="row no-gutters
                                        align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold
                                                text-secondary text-uppercase
                                                mb-1">
                                                Change from last week(sample)</div>
                                            <div class="h5 mb-0 font-weight-bold
                                                text-gray-800">+3</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-user-plus fa-2x
                                                text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-info shadow h-100
                                py-2">
                                <div class="card-body">
                                    <div class="row no-gutters
                                        align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold
                                                text-secondary text-uppercase mb-1">
                                                Average occupancy rate(sample)
                                            </div>
                                            <div class="row no-gutters
                                                align-items-center">
                                                <div class="col-auto">
                                                    <div class="h5 mb-0 mr-3
                                                        font-weight-bold
                                                        text-gray-800">72%
                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div class="progress
                                                        progress-sm mr-2">
                                                        <div class="progress-bar
                                                            bg-info"
                                                            role="progressbar"
                                                            style="width: 50%"
                                                            aria-valuenow="72"
                                                            aria-valuemin="0"
                                                            aria-valuemax="100"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-clipboard-list
                                                fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-warning shadow h-100
                                py-2">
                                <div class="card-body">
                                    <div class="row no-gutters
                                        align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold
                                                text-secondary text-uppercase
                                                mb-1">
                                                Occupancy(sample)</div>
                                            <div class="h5 mb-0 font-weight-bold
                                                text-gray-800">18</div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-people-roof fa-2x
                                                text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>
</body>


@section Scripts {
    <script src="/js/Chart.min.js"></script>
    <script type="text/javascript" src="/js/SonyApi.js"></script>
    <script type="text/javascript" src="/js/Token.js"></script>
    <script type="text/javascript" src="/js/Visualization.js"></script>

    <script>
        var currentDeviceId = undefined;

         $(document).ready(function () {
        console.debug("document.Ready");

        hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("telemetryHub")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        hubConnection.on('PeopleCounting', function (payload) {
            cosmosdbEventsProcess(payload);
        });

        hubConnection.on('Notification', function (payload) {
            notificationProcess(payload);
        });

        hubConnection.start()
            .then(() => console.log('SignalR connected!'))
            .catch(console.error);
        })  

        $(document).ready(async function () {
            toggleLoader(false);
            console.debug("Dashboard loading");

            await getToken()
                .then(async () => {
                console.log("Get Token");
                $('#notificationTextarea').val(token);
            })
            .catch((err) => {
                alert("Failed to acquire token.")
            })
            .finally(() => {
            });

            // set device list
            var selectedVal = $('#chartDeviceList option:selected').val();

            GetDevices('chartDeviceList', true, 'Select Device', '0', null)
                .then(() => { 
                })
                .catch((err) => {
                })
                .finally(() => {
                    if (selectedVal != null && selectedVal.length > 0) {
                        console.debug(selectedVal);
                        $('select[name="captureDeviceIdList"]').val(selectedVal);
                    }
                })
            toggleLoader(true);
        });

        $('#chartDeviceList').on('change', async function (evt) {
            console.debug(evt.target.id + "() " + evt.type);
            var deviceList = document.getElementById(evt.target.id);
            if ((currentDeviceId == undefined) || (currentDeviceId != deviceList[deviceList.selectedIndex].value)) {
                currentDeviceId = deviceList[deviceList.selectedIndex].value;
                chart.clear();
            }
        })

        async function cosmosdbEventsProcess(signalRMsg) {
            try {
                var message = JSON.parse(signalRMsg);

                if (message == null) {
                    return;
                }
                if (message.deviceId != currentDeviceId) {
                    return;
                }

                var count = message.count;
                var time = message.eventTime.slice(0, 10) + " " + message.eventTime.slice(11, 20);
                document.getElementById("countDisplay").innerHTML = count;
                document.getElementById("timeDisplay").innerHTML = time;
                updateChart(time, count);
            } catch (err) {
                console.error("Error processing Telemetry data for chart ");
            }
        }

        // Customize this function based on your notification method
        async function notificationProcess(signalRMsg) {
            try {
                var message = JSON.parse(signalRMsg);

                if (message == null) {
                    return;
                }
                var notification = JSON.parse(message.data);
                if (notification.PartitionKey != currentDeviceId) {
                    return;
                }
                var title = (notification.Title === null) ? '' : notification.Title;
                var content = (notification.Content === null) ? '' : notification.Content;
                $('#notificationTextarea').val(title + "\n" + content);

            } catch (err) {
                console.error("Error processing Nofiticaion");
            }
        }


    </script>
}